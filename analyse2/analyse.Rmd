---
title: "Analyse des données Minecraft"
output: html_document
---

<style>
  .col2 {
    columns: 2 200px;         /* number of columns and width in pixels*/
    -webkit-columns: 2 200px; /* chrome, safari */
    -moz-columns: 2 200px;    /* firefox */
  }
  .col3 {
    columns: 3 100px;
    -webkit-columns: 3 100px;
    -moz-columns: 3 100px;
  }
</style>

```{r include = FALSE}
#install.packages("rmarkdown")
#install.packages("ggplot2")
#install.packages("hexbin")
#install.packages("data.table")
require(ggplot2)
require(data.table)
```


```{r echo=FALSE}
#------------------- configuration
logDataLoad = TRUE

#------------------- chargement des fichiers a partir du repertoire courant
# il faut des repertoirs dataxxxxx a la racine

dirs <- list.dirs(path = ".", full.names = TRUE, recursive = FALSE)
player_id <- 0

DTA <- data.table();
DTAAInt <- data.table();
DTAInt <- data.table();
DTAItemInt <- data.table();
DTAPos <- data.table();
DTPlaces <- data.table();

if(logDataLoad)
    print("Chargement des donnees: ");

#On parse tous les dirs a la racine
for(d in dirs){
  if(logDataLoad)
    print(d);
  #si on est sur un rep de datas, c'est un nouveau joueur
  if(grepl("data",d)){
    if(logDataLoad)
      print("data");
    player_id <- player_id + 1;
    is_result = TRUE;
    
    #si c'est un rep de data mod ou vanilla, on a les bonnes vars, on load
    if(is_result){
      if(logDataLoad)
        print("Grabbing files...");
      
      #on recup le game mode
      DTModeLoc <- as.data.table(read.csv(paste(d,"/game_type.del",sep="" ),header=FALSE,sep=";"))
      setnames(DTModeLoc, old=c("V1","V2"), new=c("mode", "time"));
      DTModeLoc[, modeName:="vanilla"][mode==0, modeName:="mod"];
      
      DTAIntKindLoc <- as.data.table(read.csv(paste(d,"/actor_interaction_kind.del",sep="" ),header=FALSE,sep=";"))
      setnames(DTAIntKindLoc, old=c("V1","V2"), new=c("action", "actionName"));
      
      DTItemIntKindLoc <- as.data.table(read.csv(paste(d,"/item_interaction_kind.del",sep="" ),header=FALSE,sep=";"))
      setnames(DTItemIntKindLoc, old=c("V1","V2"), new=c("action", "actionName"));
      
      
      DTALoc <- as.data.table(read.csv(paste(d,"/actor.del",sep="" ),header=FALSE,sep=";"))
      DTALoc$MyPlayerId <- player_id
      DTA <- rbind(DTA,DTALoc);
      remove(DTALoc);
      
      DTAAIntLoc <- as.data.table(read.csv(paste(d,"/actor_actor_interaction.del",sep="" ),header=FALSE,sep=";"))
      setnames(DTAAIntLoc, old=c("V1","V2","V3","V4","V5","V6","V7","V8"), new=c("actor1", "actor2","V3","X","Y","Z","time","action"))
      DTAAIntLoc$MyPlayerId <- player_id
      DTAAIntLoc[, MyMod:=DTModeLoc[1]$modeName][time>DTModeLoc[2]$time, MyMod:=DTModeLoc[2]$modeName]
      
      #join sur les actions, pour avoir les bon noms d'action
      setkey(DTAIntKindLoc,action)
      setkey(DTAAIntLoc,action)
      DTAAIntLoc <- DTAAIntLoc[DTAIntKindLoc, nomatch=0]
      
      DTAAInt <- rbind(DTAAInt,DTAAIntLoc);
      remove(DTAAIntLoc);
      
      DTAIntLoc <- as.data.table(read.csv(paste(d,"/actor_interaction.del",sep="" ),header=FALSE,sep=";"))
      setnames(DTAIntLoc, old=c("V1","V2","V3","V4","V5","V6","V7"), new=c("actor","X","Y","Z","time","action","V7"))
      DTAIntLoc$MyPlayerId <- player_id
      DTAIntLoc[, MyMod:=DTModeLoc[1]$modeName][time>=DTModeLoc[2]$time, MyMod:=DTModeLoc[2]$modeName]
      
      #join sur les actions, pour avoir les bon noms d'action
      setkey(DTAIntKindLoc,action)
      setkey(DTAIntLoc,action)
      DTAIntLoc <- DTAIntLoc[DTAIntKindLoc, nomatch=0]
      
      DTAInt <- rbind(DTAInt,DTAIntLoc);
      remove(DTAIntLoc);
      
      DTAItemIntLoc <- as.data.table(read.csv(paste(d,"/actor_item_interaction.del",sep="" ),header=FALSE,sep=";"))
      setnames(DTAItemIntLoc, old=c("V1","V2","V3","V4","V5","V6","V7"), new=c("actor","item","X","Y","Z","time","action"))
      DTAItemIntLoc$MyPlayerId <- player_id
      DTAItemIntLoc[, MyMod:=DTModeLoc[1]$modeName][time>=DTModeLoc[2]$time, MyMod:=DTModeLoc[2]$modeName]
      
      #join sur les actions, pour avoir les bon noms d'action
      setkey(DTItemIntKindLoc,action)
      setkey(DTAItemIntLoc,action)
      DTAItemIntLoc <- DTAItemIntLoc[DTItemIntKindLoc, nomatch=0]
      
      DTAItemInt <- rbind(DTAItemInt,DTAItemIntLoc);
      remove(DTAItemIntLoc);
      
      DTAPosLoc <- as.data.table(read.csv(paste(d,"/actor_position.del",sep="" ),header=FALSE,sep=";"))
      setnames(DTAPosLoc, old=c("V1","V2","V3","V4","V5"), new=c("actor","time","X","Y","Z"))
      DTAPosLoc$MyPlayerId <- player_id
      DTAPosLoc[, MyMod:=DTModeLoc[1]$modeName][time>=DTModeLoc[2]$time, MyMod:=DTModeLoc[2]$modeName]
      DTAPos <- rbind(DTAPos,DTAPosLoc);
      remove(DTAPosLoc);
      
      DTPlacesLoc <- as.data.table(read.csv(paste(d,"/place.del",sep="" ),header=FALSE,sep=";"))
      setnames(DTPlacesLoc, old=c("V1","V2","V3","V4"), new=c("id","X","Y","Z"))
      DTPlacesLoc$MyPlayerId <- player_id
      DTPlaces <- rbind(DTPlaces,DTPlacesLoc);
      if(logDataLoad)
        print(paste("add ",nrow(DTPlacesLoc)," places"));
      remove(DTPlacesLoc);
      
      if(logDataLoad)
        print("... done");
      
    }
  }
}

DTPlaces <- as.data.table(DTPlaces)
DTAInt <- as.data.table(DTAInt)
DTAAInt <- as.data.table(DTAAInt)
DTAPos <- as.data.table(DTAPos)

```

###Description générale
```{r echo=FALSE}
nbPlayers <- nrow(DTAPos[,MyPlayerId,by=MyPlayerId])
playtime <- DTAPos[,list(playTime=floor((max(time)-min(time))/60)),by=.(MyMod,MyPlayerId)]
```
Expérience réalisée sur **`r nbPlayers`** joueurs, pour un playtime moyen de **`r round(mean(playtime$playTime),1)`** minutes ($\sigma$=`r round(sd(playtime$playTime),1)`) dans chaque mode de jeu. 

```{r echo=FALSE}
hist(playtime$playTime, xlab="Playtime (mins)", ylab="nombre de parties", main="Playtime")
```

```{r echo=FALSE}
barplot(table(DTAInt$actionName), xlab="Actions", ylab="frequence", main="Actor interaction",las=2)
barplot(table(DTAAInt$actionName), xlab="Actions", ylab="frequence", main="Actor Actor interaction",las=2)
DTPlacesNbPlaces <- DTPlaces[,.(nbPlaces=nrow(.SD)),by=.(MyPlayerId)]
barplot(table(DTPlacesNbPlaces$nbPlaces), xlab="Nb places", ylab="frequence", main="Number of places")
```

###Cartes
```{r fig.width=4, fig.height=4,echo=FALSE,out.extra=' style="float:left"'}
#trace les cartes

#on prend les positions min et max sans tenir compte du mod, pour avoir les memes echelles sur les plots
DTAPosMinMax <- DTAPos[,.(minX=min(X),maxX=max(X),minZ=min(Z),maxZ=max(Z)),by=.(MyPlayerId)]

plotMap <- function (xs,ys,mod,player){
  df <- data.frame(x=xs,y=ys)
  pl <- ggplot(df,aes(x=xs,y=ys))
  pl <- pl + geom_point(alpha = 0.2) #+ stat_binhex() 
  pl <- pl + ggtitle(paste(player,mod))
  df <- data.frame(x=mean(xs),y=mean(ys))
  pl <- pl + geom_point(data = df, aes(x=mean(xs),y=mean(ys)), colour = "red")
  
  DTPlaceNow <- DTPlaces[MyPlayerId==player];
  df <- data.frame(x=DTPlaceNow$X,y=DTPlaceNow$Z)
  pl <- pl + geom_point(data = df, aes(x=df$x,y=df$y), colour = "green")
  
  DTMinMaxNow <- DTAPosMinMax[MyPlayerId==player];
  pl <- pl + xlim(DTMinMaxNow$minX,DTMinMaxNow$maxX)
  pl <- pl + ylim(DTMinMaxNow$minZ,DTMinMaxNow$maxZ)
  
  print(pl)  
}
setkey(DTAPos,MyPlayerId,time)
void <- DTAPos[,{plotMap(X,Z,MyMod,MyPlayerId);NULL},by=.(MyMod,MyPlayerId)]
```
<div style="clear:both">&nbsp;</div>

###Lien entre mode de jeu et nombre de lieux
###ERROR : on ne stoque pas le temps de lieux, donc impossible de comparer le nombre de lieux entre chaque mod
```{r echo=FALSE}
#ajout des variables
#DTPlacesNbPlaces <- DTPlaces[,.(nbPlaces=nrow(.SD)),by=.(MyMod,MyPlayerId)]
#barplot(table(DTPlacesNbPlaces$nbPlaces), xlab="Nb places", ylab="frequence", main="Number of places")
#print(DTPlacesNbPlaces)

#data <- DTPlacesNbPlaces[MyMod=="vanilla",nbPlaces] - DTPlacesNbPlaces[MyMod=="mod",nbPlaces];
#hist(data,xlab="diff nbLieux  (vanilla - mod)", main="Delta nombre de lieux vanilla/mod")

#lien 
#fit <- aov(nbPlaces ~ MyMod, data=DTPlacesNbPlaces)
#summary(fit)
```

###Lien entre mode de jeu et nombre d'interaction
```{r echo=FALSE}
#ajout des variables
DTAAIntNb <- DTAAInt[,.(nbInt=nrow(.SD)),by=.(MyMod,MyPlayerId)]
DTAIntNb <- DTAInt[,.(nbInt=nrow(.SD)),by=.(MyMod,MyPlayerId)]
DTIntNb <- DTAAIntNb
DTIntNb$nbInt = DTAAIntNb$nbInt + DTAIntNb$nbInt
print(DTIntNb)
#data <- DTIntNb[MyMod=="vanilla",nbInt]
#data <- rbind(data,DTIntNb[MyMod=="mod",nbInt])
#barplot(data, xlab="nbActions pour chaque joueur vanilla/mod", ylab="frequence", main="Actor Actor interaction", beside=TRUE,col=c("orange","darkgreen"))
data <- DTIntNb[MyMod=="vanilla",nbInt] - DTIntNb[MyMod=="mod",nbInt];
hist(data,xlab="diff nbActions  (vanilla - mod)", main="Delta quantite d'interaction vanilla/mod")
#lien 
fit <- aov(nbInt ~ MyMod, data=DTIntNb)
summary(fit)
```


###Lien entre mode de jeu et mort du joueur
```{r echo=FALSE}
#ajout des variables
DTAAIntNb <- DTAAInt[action==9,.(nbInt=nrow(.SD)),by=.(MyMod,MyPlayerId)]

#on met à 0 la ou il y'a des NA (si un mec est pas mort dans un mode)
DTAAIntNb <- merge(DTAAIntNb[,CJ(MyMod=unique(MyMod),MyPlayerId=unique(MyPlayerId))],DTAAIntNb,by=c('MyPlayerId','MyMod'),all=TRUE)[,.(MyMod,MyPlayerId,nbInt=ifelse(!is.na(nbInt),nbInt,0))]



#DTAIntNb <- DTAInt[action==9,.(nbInt=nrow(.SD)),by=.(MyMod,MyPlayerId)]
DTIntNb <- DTAAIntNb
#DTIntNb$nbInt = DTAAIntNb$nbInt + DTAIntNb$nbInt
print(DTIntNb)
#data <- DTIntNb[MyMod=="vanilla",nbInt]
#data <- rbind(data,DTIntNb[MyMod=="mod",nbInt])
#barplot(data, xlab="nbMorts pour chaque joueur vanilla/mod", ylab="frequence", main="Actor Actor interaction", beside=TRUE,col=c("orange","darkgreen"))
data <- DTIntNb[MyMod=="vanilla",nbInt] - DTIntNb[MyMod=="mod",nbInt];
hist(data,xlab="diff nbMorts  (vanilla - mod)", main="Delta quantite mort joueur vanilla/mod")
#lien 
fit <- aov(nbInt ~ MyMod, data=DTIntNb)
#plot(x=DTLoc$nbFail, y=DTLoc$erreurdiff, main=titre)
summary(fit)
```

###Lien entre mode de jeu et distance au barycentre (valeur absolue)
```{r echo=FALSE}
#calcul du barycentre
DTAPosBarycentre <- DTAPos[,.(xBar=mean(X),yBar=mean(Y),zBar=mean(Z)),by=.(MyMod,MyPlayerId)]
DTADistBarycentre <- DTAPos[,.(dist=sqrt((X-mean(X)) * (X-mean(X)) + (Y-mean(Y)) * (Y-mean(Y)) + (Z-mean(Z)) * (Z-mean(Z)) )),by=.(MyMod,MyPlayerId)]
DTADistBarycentreMean <- DTADistBarycentre[,.(mdist=mean(dist),sddist=sd(dist)),by=.(MyMod,MyPlayerId)]
print(DTADistBarycentreMean)

data <- abs(DTADistBarycentreMean[MyMod=="vanilla",mdist] - DTADistBarycentreMean[MyMod=="mod",mdist]);
hist(data,xlab="diff dist barycentre  abs(vanilla - mod)", main="Delta dist barycentre vanilla/mod")

#lien 
fit <- aov(mdist ~ MyMod, data=DTADistBarycentreMean)
#plot(x=DTLoc$nbFail, y=DTLoc$erreurdiff, main=titre)
summary(fit)
```

###Lien entre mode de jeu et distance totale (valeur absolue)
```{r echo=FALSE}
#calcul du barycentre
setkeyv(DTAPos,c("MyPlayerId","time"))
DTADistStep <- DTAPos[,.(dist=sqrt((X-lag(X)) * (X-lag(X)) + (Y-lag(Y)) * (Y-lag(Y)) + (Z-lag(Z)) * (Z-lag(Z)) )),by=.(MyMod,MyPlayerId)]

DTADistStep <- DTAPos[,.(dx=(X-c(X[1], X[-.N])),dy=(Y-c(Y[1], Y[-.N])),dz=(Z-c(Z[1], Z[-.N]))),by=.(MyMod,MyPlayerId)]
DTADistStep <- DTADistStep[,.(dist=sqrt(dx*dx+dz*dz+dy*dy)),by=.(MyMod,MyPlayerId)]
DTADistStep <- DTADistStep[,.(distSum=sum(dist)),by=.(MyMod,MyPlayerId)]

print(DTADistStep)

data <- abs(DTADistStep[MyMod=="vanilla",distSum] - DTADistStep[MyMod=="mod",distSum]);
hist(data,xlab="diff distance totale  abs(vanilla - mod)", main="Delta dist totale vanilla/mod")

#lien 
fit <- aov(distSum ~ MyMod, data=DTADistStep)
#plot(x=DTLoc$nbFail, y=DTLoc$erreurdiff, main=titre)
summary(fit)
```

###Idees fit :
- distance parcourue en fonction du mod

###Idees descriptif:
- quantite d'interaction avec les bebetes
- placer les lieux sur les cartes



