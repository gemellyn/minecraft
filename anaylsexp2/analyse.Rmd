---
title: "Analyse des données Minecraft"
output: html_document
---

<style>
  .col2 {
    columns: 2 200px;         /* number of columns and width in pixels*/
    -webkit-columns: 2 200px; /* chrome, safari */
    -moz-columns: 2 200px;    /* firefox */
  }
  .col3 {
    columns: 3 100px;
    -webkit-columns: 3 100px;
    -moz-columns: 3 100px;
  }
</style>

```{r include = FALSE}
#install.packages("rmarkdown")
#install.packages("ggplot2")
#install.packages("hexbin")
#install.packages("data.table")
#install.packages("psych")
require(ggplot2)
require(data.table)
```


```{r echo=FALSE}
#------------------- configuration
logDataLoad = TRUE

#------------------- chargement des fichiers a partir du repertoire courant
# il faut des repertoirs dataxxxxx a la racine

dirs <- list.dirs(path = ".", full.names = TRUE, recursive = FALSE)
player_id <- 0

DTA <- data.table();
DTAAInt <- data.table();
DTAAIntPlayer <- data.table(); #actor actro interaction sur le joueur uniquement
DTAInt <- data.table();
DTAItemInt <- data.table();
DTAPos <- data.table();
DTPlaces <- data.table();
DTProcessInt <- data.table();
DTForm <- data.table();

#On parse tous les dirs a la racine
for(d in dirs){
  #si on est sur un rep de datas, c'est un nouveau joueur
  if(grepl("data",d)){
    player_id <- player_id + 1;
    is_result = TRUE;
    
    #si c'est un rep de data mod ou vanilla, on a les bonnes vars, on load
    if(is_result){
      
      #on recup le game mode
      file = paste(d,"/game_type.del",sep="" )
      if (file.info(file)$size > 0)
      {
        DTModeLoc <- as.data.table(read.csv(file, header=FALSE,sep=";"))
        setnames(DTModeLoc, old=c("V1","V2"), new=c("mode", "time"));
        DTModeLoc[, modeName:="vanilla"][mode==0, modeName:="mod"];
      }
      
      file = paste(d,"/actor_interaction_kind.del",sep="" )
      if (file.info(file)$size > 0)
      {
        DTAIntKindLoc <- as.data.table(read.csv(file, header=FALSE,sep=";"))
        setnames(DTAIntKindLoc, old=c("V1","V2"), new=c("action", "actionName"));
      }
      
      file = paste(d,"/item_interaction_kind.del",sep="" )
      if (file.info(file)$size > 0)
      {
        DTItemIntKindLoc <- as.data.table(read.csv(file, header=FALSE,sep=";"))
        setnames(DTItemIntKindLoc, old=c("V1","V2"), new=c("action", "actionName"));
      }
      
      file = paste(d,"/actor.del", sep="" )
      if (file.info(file)$size > 0)
      {
        DTALoc <- as.data.table(read.csv(file, header=FALSE,sep=";"))
        DTALoc$MyPlayerId <- player_id
        setnames(DTALoc, old=c("V1","V2","V3","V4","V5","V6"), new=c("id", "name","kind","X","Y","Z"))
        DTA <- rbind(DTA,DTALoc);
      }
      
      file = paste(d,"/actor_actor_interaction.del",sep="" )
      if (file.info(file)$size > 0)
      {
        DTAAIntLoc <- as.data.table(read.csv(file, header=FALSE,sep=";"))
        setnames(DTAAIntLoc, old=c("V1","V2","V3","V4","V5","V6","V7","V8"), new=c("actor1", "actor2","V3","X","Y","Z","time","action"))
        DTAAIntLoc$MyPlayerId <- player_id
        DTAAIntLoc[, MyMod:=DTModeLoc[1]$modeName][time>DTModeLoc[2]$time, MyMod:=DTModeLoc[2]$modeName]
        
        #join sur les actions, pour avoir les bon noms d'action
        setkey(DTAIntKindLoc,action)
        setkey(DTAAIntLoc,action)
        DTAAIntLoc <- DTAAIntLoc[DTAIntKindLoc, nomatch=0]
        
        DTAAInt <- rbind(DTAAInt,DTAAIntLoc);
        DTAAIntPlayer <- rbind(DTAAIntPlayer,DTAAIntLoc[actor1==DTALoc[kind==0]$id] );
        DTAAIntPlayer <- rbind(DTAAIntPlayer,DTAAIntLoc[actor2==DTALoc[kind==0]$id] );
      }
      
      file = paste(d,"/actor_interaction.del",sep="" )
      if (file.info(file)$size > 0)
      {
        DTAIntLoc <- as.data.table(read.csv(file, header=FALSE,sep=";"))
        setnames(DTAIntLoc, old=c("V1","V2","V3","V4","V5","V6","V7"), new=c("actor","X","Y","Z","time","action","V7"))
        DTAIntLoc$MyPlayerId <- player_id
        DTAIntLoc[, MyMod:=DTModeLoc[1]$modeName][time>=DTModeLoc[2]$time, MyMod:=DTModeLoc[2]$modeName]
        
        #join sur les actions, pour avoir les bon noms d'action
        setkey(DTAIntKindLoc,action)
        setkey(DTAIntLoc,action)
        DTAIntLoc <- DTAIntLoc[DTAIntKindLoc, nomatch=0]
        
        DTAInt <- rbind(DTAInt,DTAIntLoc);
      }
      
      file = paste(d,"/actor_item_interaction.del",sep="")
      if (file.info(file)$size > 0)
      {
        DTAItemIntLoc <- as.data.table(read.csv(file, header=FALSE,sep=";"))
        setnames(DTAItemIntLoc, old=c("V1","V2","V3","V4","V5","V6","V7"), new=c("actor","item","X","Y","Z","time","action"))
        DTAItemIntLoc$MyPlayerId <- player_id
        DTAItemIntLoc[, MyMod:=DTModeLoc[1]$modeName][time>=DTModeLoc[2]$time, MyMod:=DTModeLoc[2]$modeName]
        
        #join sur les actions, pour avoir les bon noms d'action
        setkey(DTItemIntKindLoc,action)
        setkey(DTAItemIntLoc,action)
        DTAItemIntLoc <- DTAItemIntLoc[DTItemIntKindLoc, nomatch=0]
        
        DTAItemInt <- rbind(DTAItemInt,DTAItemIntLoc);
      }
      
      file = paste(d,"/actor_position.del",sep="" )
      if (file.info(file)$size > 0)
      {
        DTAPosLoc <- as.data.table(read.csv(file, header=FALSE,sep=";"))
        setnames(DTAPosLoc, old=c("V1","V2","V3","V4","V5"), new=c("actor","time","X","Y","Z"))
        DTAPosLoc$MyPlayerId <- player_id
        DTAPosLoc[, MyMod:=DTModeLoc[1]$modeName][time>=DTModeLoc[2]$time, MyMod:=DTModeLoc[2]$modeName]
        DTAPos <- rbind(DTAPos,DTAPosLoc);
      }
      
      file = paste(d,"/place.del",sep="" )
      if (file.info(file)$size > 0)
      {
        DTPlacesLoc <- as.data.table(read.csv(file, header=FALSE,sep=";"))
        setnames(DTPlacesLoc, old=c("V1","V2","V3","V4"), new=c("id","X","Y","Z"))
        DTPlacesLoc$MyPlayerId <- player_id
        DTPlaces <- rbind(DTPlaces,DTPlacesLoc);
        if(logDataLoad)
          paste("add ",nrow(DTPlacesLoc)," places")
      }
      
      processInt <- paste(d,"/process_interaction.del",sep="" )
      if (file.size(processInt) > 0) {
        DTProcessIntLoc <- as.data.table(read.csv(paste(d,"/process_interaction.del",sep="" ),header=FALSE,sep=";"))
        setnames(DTProcessIntLoc, old=c("V1","V2","V3","V4","V5","V6","V7"), new=c("id","name","X","Y","Z","time","kind"))
        DTProcessIntLoc$MyPlayerId <- player_id
        DTProcessInt <- rbind(DTProcessInt,DTProcessIntLoc);
      } else {
        DTProcessIntLoc <- data.table(id=-1,name="",X="999999",Y="999999",Z="999999",time="-1",kind="-1")
        DTProcessIntLoc$MyPlayerId <- player_id
        DTProcessInt <- rbind(DTProcessInt,DTProcessIntLoc);
      }
      
      #on recup le formulaire
      form_file <- list.files(path=d,pattern="answers.*\\csv");
      #on teste si y'a un fichier (impossible de faire un test correct, is null et companie, r me soule)
      if(paste("test",form_file,sep="") != "test"){
        DTFormLoc <- as.data.table(read.csv(paste(d,"/",form_file,sep="" ),header=TRUE,sep=";"))
        DTFormLoc$MyPlayerId <- player_id;
        DTFormLoc$FirstCondition <- DTModeLoc[1]$modeName;
        
        DTFormLieuxLoc <- data.table(nbCharLieu1 = "nbCharLieu1", nbCharLieu2 = "nbCharLieu2", nbCharLieu3 = "nbCharLieu3", nbCharLieu4 = "nbCharLieu4", nbCharLieu5 = "nbCharLieu5", nbCharLieu6 = "nbCharLieu6", nbCharLieu7 = "nbCharLieu7", nbCharLieu8 = "nbCharLieu8", nbCharLieu9 = "nbCharLieu9", nbCharLieu10 = "nbCharLieu10", nbCharLieu11 = "nbCharLieu11", nbCharLieu12 = "nbCharLieu12", nbCharLieu13 = "nbCharLieu13", nbCharLieu14 = "nbCharLieu14", nbCharLieu15 = "nbCharLieu15")
        DTFormLieuxLoc$nbCharLieu1 <- nchar(as.character(DTFormLoc$lieu1_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu2 <- nchar(as.character(DTFormLoc$lieu2_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu3 <- nchar(as.character(DTFormLoc$lieu3_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu4 <- nchar(as.character(DTFormLoc$lieu4_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu5 <- nchar(as.character(DTFormLoc$lieu5_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu6 <- nchar(as.character(DTFormLoc$lieu6_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu7 <- nchar(as.character(DTFormLoc$lieu7_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu8 <- nchar(as.character(DTFormLoc$lieu8_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu9 <- nchar(as.character(DTFormLoc$lieu9_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu10 <- nchar(as.character(DTFormLoc$lieu10_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu11 <- nchar(as.character(DTFormLoc$lieu11_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu12 <- nchar(as.character(DTFormLoc$lieu12_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu13 <- nchar(as.character(DTFormLoc$lieu13_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu14 <- nchar(as.character(DTFormLoc$lieu14_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLieuxLoc$nbCharLieu15 <- nchar(as.character(DTFormLoc$lieu15_couleur),allowNA = FALSE,keepNA = FALSE)
        DTFormLoc$nbLieux <- 
          (if (DTFormLieuxLoc$nbCharLieu1 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu2 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu3 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu4 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu5 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu6 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu7 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu8 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu9 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu10 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu11 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu12 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu13 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu14 > 2) 1 else 0) + 
          (if (DTFormLieuxLoc$nbCharLieu15 > 2) 1 else 0)
        DTForm <- rbind(DTForm,DTFormLoc);
        remove(DTFormLieuxLoc)
      }else{
        print(paste(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>  ERROR : FORMULAIRE MANQUANT !!!! in ",d));
      }
      
      #on recup le nombre de process utilisé
      setkey(DTForm,MyPlayerId)
      setkey(DTProcessInt,MyPlayerId)
      # remove the ones that did not use the processes
      #DTFormProcess <- DTForm[DTProcessInt[kind!=-1], nomatch=0]
      DTFormProcess <- DTForm[DTProcessInt, nomatch=0]
      DTFormProcessIntNbTmp <- DTFormProcess[,nrow(.SD),by=MyPlayerId]
      setkey(DTForm,MyPlayerId)
      setkey(DTFormProcessIntNbTmp,MyPlayerId)
      DTFormProcessInt <- DTForm[DTFormProcessIntNbTmp, nomatch=0]
      setnames(DTFormProcessInt, old=c("V1"), new=c("nb"))
      remove(DTFormProcessIntNbTmp);
      
      if (!exists("DTPlacesLoc")) remove(DTPlacesLoc);
      if (!exists("DTALoc")) remove(DTALoc);
      if (!exists("DTAPosLoc")) remove(DTAPosLoc);
      if (!exists("DTAItemIntLoc")) remove(DTAItemIntLoc);
      if (!exists("DTAIntLoc")) remove(DTAIntLoc);
      if (!exists("DTAAIntLoc")) remove(DTAAIntLoc);
      remove(DTAIntKindLoc);
      if (!exists("DTModeLoc")) remove(DTModeLoc);
      remove(DTItemIntKindLoc);
      remove(DTProcessIntLoc);
      remove(DTFormLoc);
    }
  }
}

DTPlaces <- as.data.table(DTPlaces)
DTAInt <- as.data.table(DTAInt)
DTAAInt <- as.data.table(DTAAInt)
DTAPos <- as.data.table(DTAPos)

```

###Description générale
```{r echo=FALSE}
nbPlayers <- nrow(DTAPos[,MyPlayerId,by=MyPlayerId])
playtime <- DTAPos[,list(playTime=floor((max(time)-min(time))/60)),by=.(MyMod,MyPlayerId)]
```
Expérience réalisée sur **`r nbPlayers`** joueurs, pour un playtime moyen de **`r round(mean(playtime$playTime),1)`** minutes ($\sigma$=`r round(sd(playtime$playTime),1)`) dans chaque mode de jeu. 

```{r echo=FALSE}
hist(playtime$playTime, xlab="Playtime (mins)", ylab="nombre de parties", main="Playtime")
```

###Réponses aux questionnaires

```{r echo=FALSE}
DTFormCustom <- DTFormProcessInt

# Last ones that were specifically told that the powers were weird
#DTFormCustom <- tail(DTFormCustom, nrow(DTFormCustom) / 2)

```

####Q1: Profil des joueur

```{r echo=FALSE}
barplot(table(DTFormCustom$age), xlab="Âges", ylab="Participants", main="")
#barplot(table(DTForm$metier), xlab="Métier", ylab="Nombre de personnes", main="Répartition de la population par métier",las=2)
barplot(table(factor(DTFormCustom$frequence, levels = 0:4)), xlab="Fréquence", ylab="Participants", main="", names.arg=c("jamais", "presque jamais", "1 à 2 fois/mois", "1 à 2 fois/semaine", "tous les jours"), cex.names = 0.8)
#barplot(table(DTForm$plateformes), xlab="Plateformes", ylab="Nombre de personnes", main="Répartition de la population par plateforme",las=2)
barplot(table(factor(DTFormCustom$minecraft, levels = 0:3)), xlab="Expérience", ylab="Participants", main="", names.arg=c("jamais", "moins d'1h", "1h à 2h", "plus de 5h"), cex.names = 1)
barplot(table(DTFormCustom$similaire), xlab="Expérience", ylab="Participants", main="Expérience de jeux émergents",las=2)
```

####Q2: Questionnaire sur les caractéristiques

```{r echo=FALSE}
barplot(table(DTFormCustom$agency1 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez gardé le contrôle sur les événements de la partie",las=2)
summary(DTFormCustom$agency1 + 1)
wilcox.test(DTFormCustom$agency1 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$agency2 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="La partie vous a semblé suivre un parcours prédéterminé",las=2)
summary(DTFormCustom$agency2 + 1)
wilcox.test(DTFormCustom$agency2 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$agency3 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous n'avez pas réussi à atteindre vos objectifs",las=2)
summary(DTFormCustom$agency3 + 1)
wilcox.test(DTFormCustom$agency3 + 1, mu = 3, alternative = "less", conf.int = T)

psych::alpha(cbind(DTFormCustom$agency1 + 1, DTFormCustom$agency2 + 1, DTFormCustom$agency3 + 1), keys = c(1, -1, -1))


barplot(table(DTFormCustom$coherence1 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez ressenti de la frustration face aux événements",las=2)
summary(DTFormCustom$coherence1 + 1)
wilcox.test(DTFormCustom$coherence1 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$coherence2 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Les événements de la partie vous ont parus incompréhensible",las=2)
summary(DTFormCustom$coherence2 + 1)
wilcox.test(DTFormCustom$coherence2 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$coherence3 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="La partie vous a semblé chaotique",las=2)
summary(DTFormCustom$coherence3 + 1)
wilcox.test(DTFormCustom$coherence3 + 1, mu = 3, alternative = "greater", conf.int = T)

psych::alpha(cbind(DTFormCustom$coherence1 + 1, DTFormCustom$coherence2 + 1, DTFormCustom$coherence3 + 1), keys = c(-1, -1, -1))


barplot(table(DTFormCustom$incertitude1 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez été surpris par les événements",las=2)
summary(DTFormCustom$incertitude1 + 1)
wilcox.test(DTFormCustom$incertitude1 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$incertitude2 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous saviez ce qui allait se passer avant que cela ne se passe",las=2)
summary(DTFormCustom$incertitude2 + 1)
wilcox.test(DTFormCustom$incertitude2 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$incertitude3 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez eu peur de ne pas réussir à accomplir ce que vous vouliez",las=2)
summary(DTFormCustom$incertitude3 + 1)
wilcox.test(DTFormCustom$incertitude3 + 1, mu = 3, alternative = "greater", conf.int = T)

psych::alpha(cbind(DTFormCustom$incertitude1 + 1, DTFormCustom$incertitude2 + 1, DTFormCustom$incertitude3 + 1), keys = c(1, -1, -1))


barplot(table(DTFormCustom$espace1 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez trouvé la partie riche et variée",las=2)
summary(DTFormCustom$espace1 + 1)
wilcox.test(DTFormCustom$espace1 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$espace2 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous vous êtes ennuyé durant la partie",las=2)
summary(DTFormCustom$espace2 + 1)
wilcox.test(DTFormCustom$espace2 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$espace3 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez manqué de choses à voir ou à faire",las=2)
summary(DTFormCustom$espace3 + 1)
wilcox.test(DTFormCustom$espace3 + 1, mu = 3, alternative = "less", conf.int = T)

psych::alpha(cbind(DTFormCustom$espace1 + 1, DTFormCustom$espace2 + 1, DTFormCustom$espace3 + 1), keys = c(1, -1, -1))

```

####Q3: Questionnaire narratif

```{r echo=FALSE}
barplot(table(DTFormCustom$narratif1 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Durant la partie vous pouviez vous voir à la place du personnage que vous contrôliez",las=2)
summary(DTFormCustom$narratif1 + 1)
wilcox.test(DTFormCustom$narratif1 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$narratif2 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Durant la partie vous avez pensé à ce qui se passait autour de vous dans la pièce",las=2)
summary(DTFormCustom$narratif2 + 1)
wilcox.test(DTFormCustom$narratif2 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$narratif3 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Durant la partie vous étiez occupé par les événements qui s'y déroulaient",las=2)
summary(DTFormCustom$narratif3 + 1)
wilcox.test(DTFormCustom$narratif3 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$narratif4 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Après que la partie se soit terminée il était facile de l'oublier",las=2)
summary(DTFormCustom$narratif4 + 1)
wilcox.test(DTFormCustom$narratif4 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$narratif5 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous vouliez continuer à jouer pour connaître la suite des événements",las=2)
summary(DTFormCustom$narratif5 + 1)
wilcox.test(DTFormCustom$narratif5 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$narratif6 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez été marqué par les événements de la partie",las=2)
summary(DTFormCustom$narratif6 + 1)
wilcox.test(DTFormCustom$narratif6 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$narratif7 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez pensé aux événements et aux décisions qui auraient pu changer votre partie",las=2)
summary(DTFormCustom$narratif7 + 1)
wilcox.test(DTFormCustom$narratif7 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$narratif8 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez pensé à autre chose qu\'à la partie durant celle-ci",las=2)
summary(DTFormCustom$narratif8 + 1)
wilcox.test(DTFormCustom$narratif8 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$narratif9 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez développé un attachement particulier pour un objet",las=2)
summary(DTFormCustom$narratif9 + 1)
wilcox.test(DTFormCustom$narratif9 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$narratif10 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez développé un attachement particulier pour un lieu",las=2)
summary(DTFormCustom$narratif10 + 1)
wilcox.test(DTFormCustom$narratif10 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$narratif11 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez développé un attachement particulier pour un personnage du jeu",las=2)
summary(DTFormCustom$narratif11 + 1)
wilcox.test(DTFormCustom$narratif11 + 1, mu = 3, alternative = "greater", conf.int = T)
```

####Q4: Questionnaire sur les processus

```{r echo=FALSE}
barplot(table(DTFormCustom$processus1 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez cherché à comprendre le pouvoir Compagnon",las=2)
summary(DTFormCustom$processus1 + 1)
wilcox.test(DTFormCustom$processus1 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$processus2 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez cherché à comprendre le pouvoir Roi des lapins",las=2)
summary(DTFormCustom$processus2 + 1)
wilcox.test(DTFormCustom$processus2 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$processus3 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez cherché à comprendre le pouvoir Les autres",las=2)
summary(DTFormCustom$processus3 + 1)
wilcox.test(DTFormCustom$processus3 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$processus4 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous vous êtes demandé où se trouvait le compagnon lorsqu'il n'était pas devant vous",las=2)
summary(DTFormCustom$processus4 + 1)
wilcox.test(DTFormCustom$processus4 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$processus5 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous vous êtes demandé où se trouvait le roi des lapins lorsqu'il n'était pas devant vous",las=2)
summary(DTFormCustom$processus5 + 1)
wilcox.test(DTFormCustom$processus5 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$processus6 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous vous êtes demandé où se trouvait les autres lorsqu'ils n'étaient pas devant vous",las=2)
summary(DTFormCustom$processus6 + 1)
wilcox.test(DTFormCustom$processus6 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$processus7 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez une idée précise du pouvoir Compagnon",las=2)
summary(DTFormCustom$processus7 + 1)
wilcox.test(DTFormCustom$processus7 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$processus8 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez une idée précise du pouvoir Roi des lapins",las=2)
summary(DTFormCustom$processus8 + 1)
wilcox.test(DTFormCustom$processus8 + 1, mu = 3, alternative = "two.sided", conf.int = T)

barplot(table(DTFormCustom$processus9 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous avez une idée précise du pouvoir Les autres",las=2)
summary(DTFormCustom$processus9 + 1)
wilcox.test(DTFormCustom$processus9 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$processus10 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Après l'utilisation du pouvoir Compagnon il était difficile de se souvenir ce que j'étais en train de faire",las=2)
summary(DTFormCustom$processus10 + 1)
wilcox.test(DTFormCustom$processus10 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$processus11 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Après l'utilisation du pouvoir Roi des lapins il était difficile de se souvenir ce que j'étais en train de faire",las=2)
summary(DTFormCustom$processus11 + 1)
wilcox.test(DTFormCustom$processus11 + 1, mu = 3, alternative = "greater", conf.int = T)

barplot(table(DTFormCustom$processus12 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Après l'utilisation du pouvoir Les autres il était difficile de se souvenir ce que j'étais en train de faire",las=2)
summary(DTFormCustom$processus12 + 1)
wilcox.test(DTFormCustom$processus12 + 1, mu = 3, alternative = "greater", conf.int = T)

## TODO prefere et pourquoi
barplot(table(DTFormCustom$processus13 + 1), xlab="Le compagnon, le roi des lapins, les autres", ylab="Nombre de personnes", main="Quel pouvoir avez vous préféré ?",las=2)
summary(DTFormCustom$processus13 + 1)
wilcox.test(DTFormCustom$processus13 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$processus15 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous utiliseriez le pouvoir Compagnon dans d'autres contextes de jeu ou d'autres parties de Minecraft",las=2)
summary(DTFormCustom$processus15 + 1)
wilcox.test(DTFormCustom$processus15 + 1, mu = 3, alternative = "less", conf.int = T)

barplot(table(DTFormCustom$processus16 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous utiliseriez le pouvoir Roi des lapins dans d'autres contextes de jeu ou d'autres parties de Minecraft",las=2)
summary(DTFormCustom$processus16 + 1)
wilcox.test(DTFormCustom$processus16 + 1, mu = 3, alternative = "two.sided", conf.int = T)

barplot(table(DTFormCustom$processus17 + 1), xlab="Tout à fait d'accord, d'accord, ni en désaccord ni d'accord, pas d'accord, pas du tout d'accord", ylab="Nombre de personnes", main="Vous utiliseriez le pouvoir Les autres dans d'autres contextes de jeu ou d'autres parties de Minecraft",las=2)
summary(DTFormCustom$processus17 + 1)
wilcox.test(DTFormCustom$processus17 + 1, mu = 3, alternative = "greater", conf.int = T)

```

####Q5: Questionnaire sur les lieux

```{r echo=FALSE}
DTPlacesNbPlaces <- DTPlaces[,.(nbPlaces=nrow(.SD)),by=.(MyPlayerId)]

hist(DTForm$nbLieux, xlab="Nombre d'individus", ylab="Nombre de lieux trouvés", main="Nombre de lieux reconnus")
barplot(table(DTPlacesNbPlaces$nbPlaces), xlab="Nombre de lieux", ylab="Nombre d'individus", main="Nombre de lieux créés")
```

####Autres trucs

```{r echo=FALSE}
# transformer dtform de façon a avoir pour le q characteristic 1 = v, 2 = pv, 3 = n, 4 = pm etc.

#Transformer pour que pour tout le monde, ca soit 1  plutot vanilla, 5 plutot mod
#DTForm$plaisirPlutotMod = DTForm$plaisir;
#DTForm[FirstCondition=="mod",plaisirPlutotMod := as.integer(6-plaisir)]

echoPValue <- function(pv){
  
  pv = signif(pv,digits=2)
   
  if(pv<0.001) {
    return(paste(pv,"***"));
  }else if(pv<0.01){ 
    return(paste(pv,"**"));
  }else  if(pv<0.05){ 
    return(paste(pv,"*"));
  }else if(pv<0.1){ 
    return(paste(pv,"."));
  }else{
    return(paste(pv,":("));
  }
  
  return("");
}


res=data.table(vide=0);
res$sens <- echoPValue(t.test(DTForm$sens ~ DTForm$FirstCondition, var.equal=TRUE)$p.value)
res$plaisir <- echoPValue(t.test(DTForm$plaisir ~ DTForm$FirstCondition, var.equal=TRUE)$p.value)
res$interet <- echoPValue(t.test(DTForm$interet ~ DTForm$FirstCondition, var.equal=TRUE)$p.value)
res$faire <- echoPValue(t.test(DTForm$faire ~ DTForm$FirstCondition, var.equal=TRUE)$p.value)
res$situations <- echoPValue(t.test(DTForm$situations ~ DTForm$FirstCondition, var.equal=TRUE)$p.value)
res$surpris <- echoPValue(t.test(DTForm$surpris ~ DTForm$FirstCondition, var.equal=TRUE)$p.value)
res$objectifs <- echoPValue(t.test(DTForm$objectifs ~ DTForm$FirstCondition, var.equal=TRUE)$p.value)
res$manques <- echoPValue(t.test(DTForm$manques ~ DTForm$FirstCondition, var.equal=TRUE)$p.value)
res$logique <- echoPValue(t.test(DTForm$logique ~ DTForm$FirstCondition, var.equal=TRUE)$p.value)


hist(DTFormProcessInt$nb, main="Utilisation des processus", xlab="Processus")

montest <- function(table){
  DTTest <- data.table(nombre=t(table[1]))
  DTTest$content <- 1:5
  print(plot(DTTest))
  fit <- glm(content ~ nombre.V1, data=DTTest)
  print(summary(fit))  
}

DTTest <- data.table(nombre=t(DTFormPlaisir[1]))
barplot(DTTest$nombre.V1)

montest(DTFormPlaisir)
montest(DTFormSens)
montest(DTFormSituations)
montest(DTFormSurpris)
montest(DTFormPlaisir)

barplot(table(DTAInt$actionName), xlab="Actions", ylab="Frequence", main="Actor interaction",las=2)
barplot(table(DTAAInt$actionName), xlab="Actions", ylab="Frequence", main="Actor Actor interaction",las=2)
```

###Cartes
```{r fig.width=4, fig.height=4,echo=FALSE,out.extra=' style="float:left"'}
#trace les cartes

#on prend les positions min et max sans tenir compte du mod, pour avoir les memes echelles sur les plots
DTAPosMinMax <- DTAPos[,.(minX=min(X),maxX=max(X),minZ=min(Z),maxZ=max(Z)),by=.(MyPlayerId)]

plotMap <- function (xs,ys,mod,player){
  df <- data.frame(x=xs,y=ys)
  pl <- ggplot(df,aes(x=xs,y=ys))
  pl <- pl + geom_point(alpha = 0.2) #+ stat_binhex() 
  pl <- pl + ggtitle(paste(player,mod))
  df <- data.frame(x=mean(xs),y=mean(ys))
  pl <- pl + geom_point(data = df, aes(x=mean(xs),y=mean(ys)), colour = "red")
  
  DTPlaceNow <- DTPlaces[MyPlayerId==player];
  df <- data.frame(x=DTPlaceNow$X,y=DTPlaceNow$Z)
  pl <- pl + geom_point(data = df, aes(x=df$x,y=df$y), colour = "green")
  
  DTMinMaxNow <- DTAPosMinMax[MyPlayerId==player];
  pl <- pl + xlim(DTMinMaxNow$minX,DTMinMaxNow$maxX)
  pl <- pl + ylim(DTMinMaxNow$minZ,DTMinMaxNow$maxZ)
  
  print(pl)  
}
setkey(DTAPos,MyPlayerId,time)
void <- DTAPos[,{plotMap(X,Z,MyMod,MyPlayerId);NULL},by=.(MyMod,MyPlayerId)]
```
<div style="clear:both">&nbsp;</div>

```{r echo=FALSE}
###Lien entre mode de jeu et nombre de lieux
###ERROR : on ne stoque pas le temps de lieux, donc impossible de comparer le nombre de lieux entre chaque mod

#ajout des variables
#DTPlacesNbPlaces <- DTPlaces[,.(nbPlaces=nrow(.SD)),by=.(MyMod,MyPlayerId)]
#barplot(table(DTPlacesNbPlaces$nbPlaces), xlab="Nb places", ylab="frequence", main="Number of places")
#print(DTPlacesNbPlaces)

#data <- DTPlacesNbPlaces[MyMod=="vanilla",nbPlaces] - DTPlacesNbPlaces[MyMod=="mod",nbPlaces];
#hist(data,xlab="diff nbLieux  (vanilla - mod)", main="Delta nombre de lieux vanilla/mod")

#lien 
#fit <- aov(nbPlaces ~ MyMod, data=DTPlacesNbPlaces)
#summary(fit)
```

###Lien entre mode de jeu et nombre d'interaction

```{r echo=FALSE}
#ajout des variables
DTAAIntNb <- DTAAIntPlayer[,.(nbInt=nrow(.SD)),by=.(MyMod,MyPlayerId)]
DTAIntNb <- DTAInt[,.(nbInt=nrow(.SD)),by=.(MyMod,MyPlayerId)]
DTIntNb <- DTAAIntNb
DTIntNb$nbInt = DTAAIntNb$nbInt + DTAIntNb$nbInt

#lien 
fit <- aov(nbInt ~ MyMod, data=DTIntNb)
sum_fit = unlist(summary(fit))
```

Le nombre d'interactions est en moyenne de **`r round(mean(DTIntNb[MyMod=="vanilla"]$nbInt))`** ($\sigma$=`r round(sd(DTIntNb[MyMod=="vanilla"]$nbInt),1)`) en mode vanilla et de **`r round(mean(DTIntNb[MyMod=="mod"]$nbInt))`** ($\sigma$=`r round(sd(DTIntNb[MyMod=="mod"]$nbInt),1)`) en mode narration émergente. Cette différence a un taux de significativité de **`r sum_fit["Pr(>F)1"]`** 

```{r echo=FALSE}
#data <- DTIntNb[MyMod=="vanilla",nbInt]
#data <- rbind(data,DTIntNb[MyMod=="mod",nbInt])
#barplot(data, xlab="nbActions pour chaque joueur vanilla/mod", ylab="frequence", main="Actor Actor interaction", beside=TRUE,col=c("orange","darkgreen"))
data <- DTIntNb[MyMod=="vanilla",nbInt] - DTIntNb[MyMod=="mod",nbInt];
hist(data,xlab="diff nbActions  (vanilla - mod)", main="Delta quantite d'interaction vanilla/mod")
summary(fit)
```


###Lien entre mode de jeu et mort du joueur
```{r echo=FALSE}
#ajout des variables
DTAAIntNb <- DTAAIntPlayer[action==9,.(nbInt=nrow(.SD)),by=.(MyMod,MyPlayerId)]

#on met à 0 la ou il y'a des NA (si un mec est pas mort dans un mode)
DTAAIntNb <- merge(DTAAIntNb[,CJ(MyMod=unique(MyMod),MyPlayerId=unique(MyPlayerId))],DTAAIntNb,by=c('MyPlayerId','MyMod'),all=TRUE)[,.(MyMod,MyPlayerId,nbInt=ifelse(!is.na(nbInt),nbInt,0))]



#DTAIntNb <- DTAInt[action==9,.(nbInt=nrow(.SD)),by=.(MyMod,MyPlayerId)]
DTIntNb <- DTAAIntNb
#DTIntNb$nbInt = DTAAIntNb$nbInt + DTAIntNb$nbInt
print(DTIntNb)
#data <- DTIntNb[MyMod=="vanilla",nbInt]
#data <- rbind(data,DTIntNb[MyMod=="mod",nbInt])
#barplot(data, xlab="nbMorts pour chaque joueur vanilla/mod", ylab="frequence", main="Actor Actor interaction", beside=TRUE,col=c("orange","darkgreen"))
data <- DTIntNb[MyMod=="vanilla",nbInt] - DTIntNb[MyMod=="mod",nbInt];
hist(data,xlab="diff nbMorts  (vanilla - mod)", main="Delta quantite mort joueur vanilla/mod")
#lien 
fit <- aov(nbInt ~ MyMod, data=DTIntNb)
#plot(x=DTLoc$nbFail, y=DTLoc$erreurdiff, main=titre)
summary(fit)
```

###Lien entre mode de jeu et distance au barycentre (valeur absolue)
```{r echo=FALSE}
#calcul du barycentre
DTAPosBarycentre <- DTAPos[,.(xBar=mean(X),yBar=mean(Y),zBar=mean(Z)),by=.(MyMod,MyPlayerId)]
DTADistBarycentre <- DTAPos[,.(dist=sqrt((X-mean(X)) * (X-mean(X)) + (Y-mean(Y)) * (Y-mean(Y)) + (Z-mean(Z)) * (Z-mean(Z)) )),by=.(MyMod,MyPlayerId)]
DTADistBarycentreMean <- DTADistBarycentre[,.(mdist=mean(dist),sddist=sd(dist)),by=.(MyMod,MyPlayerId)]
print(DTADistBarycentreMean)

data <- DTADistBarycentreMean[MyMod=="vanilla",mdist] - DTADistBarycentreMean[MyMod=="mod",mdist];
hist(data,xlab="diff dist barycentre vanilla - mod", main="Delta dist barycentre vanilla/mod")

#lien 
fit <- aov(mdist ~ MyMod, data=DTADistBarycentreMean)
#plot(x=DTLoc$nbFail, y=DTLoc$erreurdiff, main=titre)
summary(fit)
```

###Lien entre mode de jeu et distance totale (valeur absolue)
```{r echo=FALSE}
#calcul du barycentre
setkeyv(DTAPos,c("MyPlayerId","time"))
DTADistStep <- DTAPos[,.(dist=sqrt((X-lag(X)) * (X-lag(X)) + (Y-lag(Y)) * (Y-lag(Y)) + (Z-lag(Z)) * (Z-lag(Z)) )),by=.(MyMod,MyPlayerId)]

DTADistStep <- DTAPos[,.(dx=(X-c(X[1], X[-.N])),dy=(Y-c(Y[1], Y[-.N])),dz=(Z-c(Z[1], Z[-.N]))),by=.(MyMod,MyPlayerId)]
DTADistStep <- DTADistStep[,.(dist=sqrt(dx*dx+dz*dz+dy*dy)),by=.(MyMod,MyPlayerId)]
DTADistStep <- DTADistStep[,.(distSum=sum(dist)),by=.(MyMod,MyPlayerId)]

print(DTADistStep)

data <- DTADistStep[MyMod=="vanilla",distSum] - DTADistStep[MyMod=="mod",distSum];
hist(data,xlab="diff distance totale  vanilla - mod", main="Delta dist totale vanilla/mod")

#lien 
fit <- aov(distSum ~ MyMod, data=DTADistStep)
#plot(x=DTLoc$nbFail, y=DTLoc$erreurdiff, main=titre)
summary(fit)
```

###Idees fit :
- checker leffet de l'ordre en prenant les réponses des cas firstcondition == vanilla et inversement
- checker le nombre typés des interactions (kill, dig, build, etc.) -> chi2 sur col (type int) et ligne (type partie)
- checker comment tester les likert scales

###Idees descriptif:
- quantite d'interaction avec les process

###Nettoyage
- virer ceux qui n'ont pas joue tout le temps (temps sans action trop long)
- virer ceux qui n'ont eu que vanilla ou que mod (table game_type avec une seule ligne)



